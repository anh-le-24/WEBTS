<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="~/Content/Css/PaymentStyleSheet.css" rel="stylesheet">

    @{
        Layout = "~/Views/Shared/nav.cshtml";
    }
</head>
<body>

    <!-- Phần thân -->
    <form action="~/Home/ThanhToanHD" method="post">
        <input type="hidden" name="voucherId" id="voucherId" />
        <main>
            <div class="checkout-container">
                <h3>Thông tin đơn hàng</h3>

                <!-- Store Selection -->
                <div class="store-selection">
                    <div class="store-icon">
                        <img src="~/Content/Picture/shop.jpg" alt="Alternate Text" />
                    </div>
                </div>

                <!-- Product Details -->
                @foreach (var gh in ViewBag.list) {
                    <div class="product-details">
                        <div class="product-image">
                            <img src="~/Content/Picture/@gh[7]" alt="Product Image">
                        </div>
                        <div class="product-info">
                            <p><strong>@gh[5]</strong></p>
                            <p>số lượng: <strong>@gh[2]</strong></p>
                            <p>@gh[8]</p>
                            <span id="tongtiensp_@gh[1]" class="product-price">@gh[3] VNĐ</span>
                        </div>
                    </div>
                }

                <!-- Promo Code Button Section -->
                <div class="promo-code-button">
                    <input type="text" placeholder="Số tiền được giảm" id="promoCode" readonly />
                    <button type="button" onclick="toggleVoucherForm()">Thêm khuyến mãi</button>
                </div>

                <!-- Voucher Form Section -->
                <div id="voucherForm" class="voucher-form-overlay" style="display: none;">
                    <div class="voucher-form-content">
                        <!-- Close Button -->
                        <button type="button" class="close-button" onclick="toggleVoucherForm()">×</button>
                        <!-- Voucher Search Bar -->
                        <form class="search-container" action="~/Home/SearchVch">
                            <input type="text" class="search-bar" placeholder="Tìm kiếm mã giảm giá..." name="phantramgiam" />
                            <button type="submit" class="search-button">Tìm kiếm</button>
                        </form>

                        <!-- Voucher Cards Container -->
                        <div class="coupon-container">
                            @foreach (var vc in ViewBag.listVC) {
                                var startDate = DateTime.Parse(vc[4].ToString());
                                var endDate = DateTime.Parse(vc[5].ToString());
                                var remainingTimeSpan = endDate - DateTime.Now;

                                <div class="coupon">
                                    <div class="coupon-left">
                                        <div class="tag">HOT</div>
                                        <img alt="Shop icon" src="~/Content/Picture/discount.png" />
                                    </div>
                                    <div class="coupon-right">
                                        <div class="discount">@vc[2]-@vc[6]% </div>
                                        <div class="min-order">Đơn hàng trên @vc[7] VND</div>
                                        <div class="expiry">
                                            @if (remainingTimeSpan.TotalSeconds > 0) {
                                                if (remainingTimeSpan.TotalHours > 24) {
                                                    var days = (int)remainingTimeSpan.TotalDays;
                                                    var hours = remainingTimeSpan.Hours;
                                                    <span>Sắp hết hạn: Còn @days ngày @hours giờ</span>
                                                }
                                                else {
                                                    var hours = (int)remainingTimeSpan.TotalHours;
                                                    <span>Sắp hết hạn: Còn @hours giờ</span>
                                                }
                                            }
                                            else {
                                                <span style="color: red;">Voucher đã hết hạn</span>
                                            }
                                        </div>
                                        <a class="conditions" href="#">@vc[3]</a>
                                        <!-- Standard Form Submission for Voucher -->
                                        <button type="button" class="save" onclick="applyVoucher(@vc[6], @vc[7], '@vc[0]', '@vc[5]')">Áp dụng</button>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>


                <!-- Price Details -->
                <div class="price-details">
                    <div class="row">
                        <span>Tổng:</span>
                        <input id="totalAmount" value="0" name="tongtiensp" readonly />
                    </div>
                    <div class="row">
                        <span>Phí vận chuyển:</span>
                        <span id="phivanchuyen">0đ</span>
                    </div>

                    <div class="row">
                        <label for="quick">Chọn nhanh</label>
                        <input type="radio" id="quick" name="shippingspeed" value="nhanh ch" onclick="updateShippingCost('quick')">

                        <label for="slow">Chọn chậm</label>
                        <input type="radio" id="slow" name="shippingspeed" value="slow" onclick="updateShippingCost('slow')">
                    </div>

                    <div class="row">
                        <span>Khuyến mại:</span>
                        <input id="khuyenmai" value="0" name="khuyenmai" readonly />
                    </div>

                    <div class="row">
                        <span><strong>Tổng cộng:</strong></span>
                        <input id="finalTotal" name="finalTotal" readonly />
                    </div>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="order-button">ĐẶT HÀNG</button>
                    <a href="@Url.Action("ListSanPham","Home")" class="continue-shopping">TIẾP TỤC MUA HÀNG</a>
                </div>
            </div>
        </main>
    </form>

    <script>
        // Hàm tính tổng tiền của các sản phẩm
        function calculateTotalAmount() {
            let totalAmount = 0;
            let productPrices = document.querySelectorAll('.product-price');
            productPrices.forEach(function (priceElement) {
                let price = parseInt(priceElement.textContent.replace(' VNĐ', '').replace(',', '').trim());
                totalAmount += price;
            });
            document.getElementById('totalAmount').value = totalAmount;
            updateShippingCost(document.querySelector('input[name="shippingspeed"]:checked')?.value || 'quick');
        }

        // Hàm cập nhật giá trị phí vận chuyển và tính toán tổng cộng
        // Hàm cập nhật giá trị phí vận chuyển và tính toán tổng cộng
        function updateShippingCost(shippingType) {
            let totalAmount = parseInt(document.getElementById('totalAmount').value);
            let shippingCost = 0;
            let khuyenMai = parseInt(document.getElementById('khuyenmai').value) || 0;

            // Tính phí vận chuyển
            if (shippingType === 'quick') {
                shippingCost = 5000;
            } else if (shippingType === 'slow') {
                shippingCost = 2000;
            }

            // Hiển thị phí vận chuyển
            document.getElementById('phivanchuyen').textContent = shippingCost + 'đ';

            // Tính tổng cộng
            let finalTotal = totalAmount + shippingCost - khuyenMai;
            document.getElementById('finalTotal').value = finalTotal;
        }

        // Hàm thêm khuyến mãi
        function addPromoCode() {
            let promoValue = prompt("Nhập giá trị khuyến mãi:"); // Ví dụ nhập khuyến mãi
            let khuyenMai = parseInt(promoValue);

            if (khuyenMai && khuyenMai > 0) {
                document.getElementById('khuyenmai').value = khuyenMai;
                updateShippingCost(document.querySelector('input[name="shipping_speed"]:checked')?.value || 'quick');
            }
        }

        // Hàm áp dụng voucher và tính toán số tiền giảm
        function applyVoucher(discountPercent, minOrderAmount, voucherId, expiryDate) {
            let totalAmount = parseInt(document.getElementById('totalAmount').value);

            // Kiểm tra xem voucher có hết hạn không
            let now = new Date();
            let voucherExpiryDate = new Date(expiryDate);

            if (voucherExpiryDate < now) {
                alert("Voucher đã hết hạn. Vui lòng chọn voucher khác.");
                return; // Không cho phép áp dụng voucher đã hết hạn
            }

            // Kiểm tra xem voucher có đủ điều kiện được áp dụng không
            if (totalAmount >= minOrderAmount) {
                let discountAmount = Math.floor((totalAmount * discountPercent) / 100);

                // Cập nhật giá trị khuyến mãi vào trường hợp ẩn
                document.getElementById('khuyenmai').value = discountAmount;
                document.getElementById('promoCode').value = discountAmount + ' VNĐ';

                // Lưu voucher ID vào input ẩn
                document.getElementById('voucherId').value = voucherId; // Lưu ID voucher

                // Kiểm tra console.log giá trị voucherId
                console.log("Voucher ID:", document.getElementById('voucherId').value);

                // Tính lại tổng tiền
                updateShippingCost(document.querySelector('input[name="shippingspeed"]:checked')?.value || 'quick');

                // Đóng form voucher
                toggleVoucherForm();

                alert("Voucher đã được áp dụng thành công!");
            } else {
                alert("Không đủ điều kiện để áp dụng voucher. Tổng tiền đơn hàng phải từ " + minOrderAmount + " VND trở lên.");
            }
        }


        // Toggle voucher form display
        function toggleVoucherForm() {
            let voucherForm = document.getElementById("voucherForm");
            voucherForm.style.display = (voucherForm.style.display === "none" || voucherForm.style.display === "") ? "flex" : "none";
        }

        // Calculate total amount on page load
        window.onload = calculateTotalAmount;

    </script>


</body>
</html>