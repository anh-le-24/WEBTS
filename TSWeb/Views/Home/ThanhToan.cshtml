<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="~/Content/Css/PaymentStyleSheet.css" rel="stylesheet">

    @{
        Layout = "~/Views/Shared/nav.cshtml";
    }
</head>
<body>

    <!-- Phần thân -->
    <form action="~/Home/ThanhToanHD" method="post" onsubmit="return confirmOrder()">
        <input type="text" name="voucherId" />
        <main>
            <div class="checkout-container">
                <h3>Thông tin đơn hàng</h3>

                <!-- Store Selection -->
                <div class="store-selection">
                    <div class="store-icon">
                        <img src="~/Content/Picture/shop.jpg" alt="Alternate Text" />
                    </div>
                </div>

                <!-- Product Details -->
                @foreach (var gh in ViewBag.list) {
                    <div class="product-details">
                        <div class="product-image">
                            <img src="~/Content/Picture/@gh[7]" alt="Product Image">
                        </div>
                        <div class="product-info">
                            <p><strong>@gh[5]</strong></p>
                            <p>số lượng: <strong>@gh[2]</strong></p>
                            <p>@gh[8]</p>
                            <span id="tongtiensp_@gh[1]" class="product-price">@gh[3] VNĐ</span>
                        </div>
                    </div>
                }

                <!-- Promo Code Button Section -->
                <div class="promo-code-button">
                    <input type="text" placeholder="Số tiền được giảm" id="promoCode" readonly />
                    <button type="button" onclick="toggleVoucherForm()">Thêm khuyến mãi</button>
                </div>

                <!-- Voucher Form Section -->
                <div id="voucherForm" class="voucher-form-overlay" style="display: none;">
                    <div class="voucher-form-content">
                        <!-- Close Button -->
                        <button type="button" class="close-button" onclick="toggleVoucherForm()">×</button>

                        <!-- Voucher Cards Container -->
                        <div class="coupon-container">
                            @foreach (var vc in ViewBag.listVC) {
                                var startDate = DateTime.Parse(vc[4].ToString());
                                var endDate = DateTime.Parse(vc[5].ToString());
                                var now = DateTime.Now;
                                var remainingTimeSpan = endDate - now;
                                var notYetActive = startDate > now; // Kiểm tra nếu chưa đến ngày bắt đầu

                                <div class="coupon" data-voucher-id="@vc[0]">
                                    <div class="coupon-left">
                                        <div class="tag">HOT</div>
                                        <img alt="Shop icon" src="~/Content/Picture/discount.png" />
                                    </div>
                                    <div class="coupon-right">
                                        <div class="discount">@vc[2]-@vc[6]% </div>
                                        <div class="min-order">Đơn hàng trên @vc[7] VND</div>
                                        <div class="expiry">
                                            @if (notYetActive) {
                                                // Chưa đến ngày bắt đầu
                                                <span style="color: blue;">Hiệu lực từ: @startDate.ToString("dd/MM/yyyy")</span>
                                            }
                                            else if (remainingTimeSpan.TotalSeconds > 0) {
                                                // Phiếu còn hiệu lực
                                                if (remainingTimeSpan.TotalHours > 24) {
                                                    var days = (int)remainingTimeSpan.TotalDays;
                                                    var hours = remainingTimeSpan.Hours;
                                                    <span>Sắp hết hạn: Còn @days ngày @hours giờ</span>
                                                }
                                                else {
                                                    var hours = (int)remainingTimeSpan.TotalHours;
                                                    var minutes = remainingTimeSpan.Minutes;
                                                    <span>Sắp hết hạn: Còn @hours giờ @minutes phút</span>
                                                }
                                            }
                                            else {
                                                // Phiếu đã hết hạn
                                                <span style="color: red;">Voucher đã hết hạn</span>
                                            }
                                        </div>
                                        <a class="conditions" href="#">@vc[3]</a>
                                        <!-- Standard Form Submission for Voucher -->
                                        <button type="button" class="save" onclick="applyVoucher(@vc[6], @vc[7], '@vc[0]', '@vc[5]', '@vc[4]')">Áp dụng</button>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>


                <!-- Price Details -->
                <div class="price-details">
                    <div class="row">
                        <span>Tổng:</span>
                        <input id="totalAmount" value="0" name="tongtiensp" readonly />
                    </div>
                    <div class="row">
                        <span>Phí vận chuyển:</span>
                        <span id="phivanchuyen">0đ</span>
                    </div>

                    <div class="row">
                        <label for="quick">Chọn nhanh</label>
                        <input type="radio" id="quick" name="shippingspeed" value="nhanh ch" onclick="updateShippingCost('quick')">

                        <label for="slow">Chọn chậm</label>
                        <input type="radio" id="slow" name="shippingspeed" value="slow" onclick="updateShippingCost('slow')">
                    </div>

                    <div class="row">
                        <span>Khuyến mại:</span>
                        <input id="khuyenmai" value="0" name="khuyenmai" readonly />
                    </div>

                    <!-- Điểm tích lũy -->
                    @foreach (var d in ViewBag.listD) {
                        <div class="row">
                            <label for="useLoyaltyPoints">Sử dụng điểm tích lũy: @d[0] điểm</label>
                            <input type="checkbox" id="useLoyaltyPoints" onchange="handleLoyaltyPoints(@d[0])">
                            <!-- Trường ẩn lưu giá trị quy đổi từ điểm tích lũy -->
                            <input type="hidden" id="loyaltyPointsUsed" name="loyaltyPointsUsed" value="0">
                        </div>
                    }

                    <div class="row">
                        <span><strong>Tổng cộng:</strong></span>
                        <input id="finalTotal" name="finalTotal" readonly />
                    </div>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="order-button">ĐẶT HÀNG</button>
                    <a href="@Url.Action("ListSanPham","Home")" class="continue-shopping">TIẾP TỤC MUA HÀNG</a>
                </div>
            </div>
        </main>
    </form>

    <script>

        // Confirmation before submitting the order
        function confirmOrder() {
            let confirmMessage = "Bạn chắc chắn muốn đặt hàng?";

            // Check if voucher is applied but not reflected in the form
            let voucherId = document.getElementById('voucherId').value;
            let discountValue = parseInt(document.getElementById('khuyenmai').value) || 0;

            if (voucherId && discountValue > 0) {
                // Double-check values are correctly set
                console.log("Voucher áp dụng: ", voucherId, "Giá trị giảm: ", discountValue);
            } else {
                console.warn("Chưa áp dụng voucher hoặc giá trị không đúng.");
            }

            // Show a confirmation dialog
            if (confirm(confirmMessage)) {
                return true;  // Continue submitting the form
            } else {
                return false;  // Prevent form submission
            }
        }

        // Hàm tính tổng tiền của các sản phẩm
        function calculateTotalAmount() {
            let totalAmount = 0;
            let productPrices = document.querySelectorAll('.product-price');
            productPrices.forEach(function (priceElement) {
                let price = parseInt(priceElement.textContent.replace(' VNĐ', '').replace(',', '').trim());
                totalAmount += price;
            });
            document.getElementById('totalAmount').value = totalAmount;
            updateShippingCost(document.querySelector('input[name="shippingspeed"]:checked')?.value || 'quick');
        }

        // Hàm cập nhật giá trị phí vận chuyển và tính toán tổng cộng
        function updateShippingCost(shippingType) {
            let totalAmount = parseInt(document.getElementById('totalAmount').value) || 0;
            let shippingCost = parseInt(document.getElementById('phivanchuyen').textContent.replace('đ', '').trim()) || 0;
            let khuyenMai = parseInt(document.getElementById('khuyenmai').value) || 0;
            let loyaltyPointsUsed = parseInt(document.getElementById('loyaltyPointsUsed').value) || 0;

            // Kiểm tra loại vận chuyển và gán phí vận chuyển tương ứng
            if (shippingType === 'quick') {
                shippingCost = 5000;
            } else if (shippingType === 'slow') {
                shippingCost = 2000;
            }

            // Hiển thị phí vận chuyển
            document.getElementById('phivanchuyen').textContent = shippingCost + 'đ';

            // Tính tổng cộng
            let finalTotal = totalAmount + shippingCost - khuyenMai - loyaltyPointsUsed;

            // Đảm bảo tổng cộng không âm
            document.getElementById('finalTotal').value = finalTotal < 0 ? 0 : finalTotal;
        }


        // Hàm thêm khuyến mãi
        function addPromoCode() {
            let promoValue = prompt("Nhập giá trị khuyến mãi:"); // Ví dụ nhập khuyến mãi
            let khuyenMai = parseInt(promoValue);

            if (khuyenMai && khuyenMai > 0) {
                document.getElementById('khuyenmai').value = khuyenMai;
                updateShippingCost(document.querySelector('input[name="shipping_speed"]:checked')?.value || 'quick');
            }
        }

        // Hàm áp dụng voucher và tính toán số tiền giảm
        // Hàm áp dụng voucher và tính toán số tiền giảm
        function applyVoucher(discountPercent, minOrderAmount, voucherId, expiryDate, startDate) {
            let totalAmount = parseInt(document.getElementById('totalAmount').value);

            let now = new Date();
            let voucherExpiryDate = new Date(expiryDate);
            let voucherStartDate = new Date(startDate);

            if (voucherStartDate > now) {
                alert("Voucher chưa đến ngày áp dụng. Vui lòng chọn voucher khác.");
                return;
            }

            if (voucherExpiryDate < now) {
                alert("Voucher đã hết hạn. Vui lòng chọn voucher khác.");
                return;
            }

            if (totalAmount >= minOrderAmount) {
                let discountAmount = Math.floor((totalAmount * discountPercent) / 100);

                // Set the discount and voucher information
                document.getElementById('khuyenmai').value = discountAmount; // Giá trị giảm
                document.getElementById('promoCode').value = discountAmount + ' VNĐ'; // Hiển thị giảm giá
                document.getElementById('voucherId').value = voucherId; // Lưu voucherId để gửi lên server

                // Tính lại tổng tiền
                updateShippingCost(document.querySelector('input[name="shippingspeed"]:checked')?.value || 'quick');

                // Ẩn voucher đã áp dụng
                let voucherElement = document.querySelector(`.coupon[data-voucher-id="${voucherId}"]`);
                if (voucherElement) {
                    voucherElement.style.display = "none"; // Ẩn voucher
                }

                toggleVoucherForm();

                alert("Voucher đã được áp dụng thành công!");
            } else {
                alert("Không đủ điều kiện để áp dụng voucher. Tổng tiền đơn hàng phải từ " + minOrderAmount + " VND trở lên.");
            }
        }


    // Hàm thêm logic điểm tích lũy
    function handleLoyaltyPoints(points) {
    let checkbox = document.getElementById('useLoyaltyPoints');
    let loyaltyPointsUsed = document.getElementById('loyaltyPointsUsed'); // Input ẩn để gửi giá trị về server

    // Nếu checkbox được chọn
    if (checkbox.checked) {
    loyaltyPointsUsed.value = points; // Cập nhật giá trị điểm tích lũy được sử dụng
    } else {
    loyaltyPointsUsed.value = 0; // Không sử dụng điểm tích lũy
    }

    // Cập nhật tổng tiền mà không thay đổi loại vận chuyển
    let currentShippingType = document.querySelector('input[name="shippingspeed"]:checked')?.value || 'quick';
    updateShippingCost(currentShippingType); // Truyền loại vận chuyển hiện tại
    }


    // Toggle voucher form display
    function toggleVoucherForm() {
    let voucherForm = document.getElementById("voucherForm");
    voucherForm.style.display = (voucherForm.style.display === "none" || voucherForm.style.display === "") ? "flex" : "none";
    }

    window.onload = function () {
    calculateTotalAmount();
    document.getElementById('quick').checked = true; // Mặc định chọn vận chuyển nhanh
    updateShippingCost('quick'); // Áp dụng vận chuyển nhanh ngay khi tải trang
    };

    </script>


</body>
</html>